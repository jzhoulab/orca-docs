

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>orca_predict &mdash; Orca 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Orca
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../orca_predict.html">orca_predict module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../orca_utils.html">orca_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../orca_models.html">orca_models module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../orca_modules.html">orca_modules module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../selene_utils2.html">selene_utils2 module</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Orca</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>orca_predict</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for orca_predict</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides functions for using Orca models for various</span>
<span class="sd">types of the predictions. This is the main module that you need for </span>
<span class="sd">interacting with Orca models.</span>

<span class="sd">To use any of the prediction functions, `load_resources` has to be</span>
<span class="sd">called first to load the necessary resources.</span>

<span class="sd">The coordinates used in Orca are 0-based, inclusive for the start</span>
<span class="sd">coordinate and exclusive for the end coordinate, consistent with</span>
<span class="sd">python conventions. </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">spearmanr</span>

<span class="kn">from</span> <span class="nn">selene_utils2</span> <span class="k">import</span> <span class="n">MemmapGenome</span><span class="p">,</span> <span class="n">Genomic2DFeatures</span>
<span class="kn">import</span> <span class="nn">selene_sdk</span>
<span class="kn">from</span> <span class="nn">selene_sdk.sequences</span> <span class="k">import</span> <span class="n">Genome</span>

<span class="kn">from</span> <span class="nn">orca_models</span> <span class="k">import</span> <span class="n">H1esc</span><span class="p">,</span> <span class="n">Hff</span><span class="p">,</span> <span class="n">H1esc_1M</span><span class="p">,</span> <span class="n">Hff_1M</span><span class="p">,</span> <span class="n">H1esc_256M</span><span class="p">,</span> <span class="n">Hff_256M</span>
<span class="kn">from</span> <span class="nn">orca_utils</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">genomeplot</span><span class="p">,</span>
    <span class="n">genomeplot_256Mb</span><span class="p">,</span>
    <span class="n">StructuralChange2</span><span class="p">,</span>
    <span class="n">process_anno</span><span class="p">,</span>
    <span class="n">coord_round</span><span class="p">,</span>
    <span class="n">coord_clip</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ORCA_PATH</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>


<div class="viewcode-block" id="load_resources"><a class="viewcode-back" href="../orca_predict.html#orca_predict.load_resources">[docs]</a><span class="k">def</span> <span class="nf">load_resources</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;32M&quot;</span><span class="p">],</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_memmapgenome</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load resources for Orca predictions including the specified </span>
<span class="sd">    Orca models and hg38 reference genome. It also creates Genomic2DFeatures</span>
<span class="sd">    objects for experimental micro-C  datasets (for comparison with prediction).</span>
<span class="sd">    Load resourced are accessible as global variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models : list(str)</span>
<span class="sd">        List of model types to load, supported model types includes</span>
<span class="sd">        &quot;32M&quot;, &quot;256M&quot;, &quot;1M&quot;, corresponding to 1-32Mb, 32-256Mb, and 1Mb</span>
<span class="sd">        models. Lower cases are also accepted.  </span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. If true, loaded models are moved to GPU.</span>
<span class="sd">    use_memmapgenome : bool, optional</span>
<span class="sd">        Default is True. If True and the resource file for hg38 mmap exists,</span>
<span class="sd">        use MemmapGenome instead of Genome.</span>

<span class="sd">    Global variables</span>
<span class="sd">    ----------------</span>
<span class="sd">    hg38 : MemmapGenome or Genome</span>
<span class="sd">        If `use_memmapgenome==True` and the resource file for hg38 mmap exists,</span>
<span class="sd">        use MemmapGenome instead of Genome.</span>
<span class="sd">    h1esc : orca_models.H1esc</span>
<span class="sd">        1-32Mb Orca H1-ESC model</span>
<span class="sd">    hff : orca_models.Hff</span>
<span class="sd">        1-32Mb Orca HFF model</span>
<span class="sd">    h1esc_256m : orca_models.H1esc_256M</span>
<span class="sd">        32-256Mb Orca H1-ESC model</span>
<span class="sd">    hff_256m : orca_models.Hff_256M</span>
<span class="sd">        32-256Mb Orca HFF model</span>
<span class="sd">    h1esc_1m : orca_models.H1esc_1M</span>
<span class="sd">        1Mb Orca H1-ESC model</span>
<span class="sd">    hff_1m : orca_models.Hff_1M</span>
<span class="sd">        1Mb Orca HFF model</span>
<span class="sd">    target_h1esc : Genomic2DFeatures</span>
<span class="sd">        Genomic2DFeatures object that load H1-ESC micro-C dataset 4DNFI9GMP2J8</span>
<span class="sd">        at 4kb resolution, used for comparison with 1-32Mb models.</span>
<span class="sd">    target_hff : Genomic2DFeatures</span>
<span class="sd">        Genomic2DFeatures object that load HFF micro-C dataset 4DNFI643OYP9</span>
<span class="sd">        at 4kb resolution, used for comparison with 1-32Mb models.</span>
<span class="sd">    target_h1esc_256m : Genomic2DFeatures</span>
<span class="sd">        Genomic2DFeatures object that load H1-ESC micro-C dataset 4DNFI9GMP2J8</span>
<span class="sd">        at 32kb resolution, used for comparison with 32-256Mb models.</span>
<span class="sd">    target_hff_256m : Genomic2DFeatures</span>
<span class="sd">        Genomic2DFeatures object that load HFF micro-C dataset 4DNFI643OYP9</span>
<span class="sd">        at 32kb resolution, used for comparison with 32-256Mb models.</span>
<span class="sd">    target_h1esc_1m : Genomic2DFeatures</span>
<span class="sd">        Genomic2DFeatures object that load H1-ESC micro-C dataset 4DNFI9GMP2J8</span>
<span class="sd">        at 32kb resolution, used for comparison with 1Mb models.</span>
<span class="sd">    target_hff_1m : Genomic2DFeatures</span>
<span class="sd">        Genomic2DFeatures object that load HFF micro-C dataset 4DNFI643OYP9</span>
<span class="sd">        at 1kb resolution, used for comparison with 1Mb models.</span>
<span class="sd">    target_available : bool</span>
<span class="sd">        Indicate whether the micro-C dataset resource file is available.</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">hg38</span><span class="p">,</span> <span class="n">target_hff</span><span class="p">,</span> <span class="n">target_h1esc</span><span class="p">,</span> <span class="n">target_hff_256m</span><span class="p">,</span> <span class="n">target_h1esc_256m</span><span class="p">,</span> <span class="n">target_hff_1m</span><span class="p">,</span> <span class="n">target_h1esc_1m</span><span class="p">,</span> <span class="n">target_available</span>

    <span class="k">if</span> <span class="s2">&quot;32M&quot;</span> <span class="ow">or</span> <span class="s2">&quot;32m&quot;</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">h1esc</span><span class="p">,</span> <span class="n">hff</span>
        <span class="n">h1esc</span> <span class="o">=</span> <span class="n">H1esc</span><span class="p">()</span>
        <span class="n">h1esc</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">hff</span> <span class="o">=</span> <span class="n">Hff</span><span class="p">()</span>
        <span class="n">hff</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
            <span class="n">h1esc</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">hff</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h1esc</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">hff</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;1M&quot;</span> <span class="ow">or</span> <span class="s2">&quot;1m&quot;</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">h1esc_1m</span><span class="p">,</span> <span class="n">hff_1m</span>
        <span class="n">h1esc_1m</span> <span class="o">=</span> <span class="n">H1esc_1M</span><span class="p">()</span>
        <span class="n">h1esc_1m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">hff_1m</span> <span class="o">=</span> <span class="n">Hff_1M</span><span class="p">()</span>
        <span class="n">hff_1m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
            <span class="n">h1esc_1m</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">hff_1m</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h1esc_1m</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">hff_1m</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;256M&quot;</span> <span class="ow">or</span> <span class="s2">&quot;256m&quot;</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">h1esc_256m</span><span class="p">,</span> <span class="n">hff_256m</span>
        <span class="n">h1esc_256m</span> <span class="o">=</span> <span class="n">H1esc_256M</span><span class="p">()</span>
        <span class="n">h1esc_256m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">hff_256m</span> <span class="o">=</span> <span class="n">Hff_256M</span><span class="p">()</span>
        <span class="n">hff_256m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
            <span class="n">h1esc_256m</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">hff_256m</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h1esc_256m</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">hff_256m</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">use_memmapgenome</span>
        <span class="ow">and</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/resources/Homo_sapiens.GRCh38.dna.primary_assembly.fa.mmap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="n">hg38</span> <span class="o">=</span> <span class="n">MemmapGenome</span><span class="p">(</span>
            <span class="n">input_path</span><span class="o">=</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/Homo_sapiens.GRCh38.dna.primary_assembly.fa&quot;</span><span class="p">,</span>
            <span class="n">memmapfile</span><span class="o">=</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/Homo_sapiens.GRCh38.dna.primary_assembly.fa.mmap&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hg38</span> <span class="o">=</span> <span class="n">Genome</span><span class="p">(</span>
            <span class="n">input_path</span><span class="o">=</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/Homo_sapiens.GRCh38.dna.primary_assembly.fa&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">target_available</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI643OYP9.rebinned.mcool&quot;</span><span class="p">):</span>
        <span class="n">target_hff</span> <span class="o">=</span> <span class="n">Genomic2DFeatures</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI643OYP9.rebinned.mcool::/resolutions/4000&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;r4000&quot;</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span>
            <span class="n">cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">target_hff_256m</span> <span class="o">=</span> <span class="n">Genomic2DFeatures</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI643OYP9.rebinned.mcool::/resolutions/32000&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;r32000&quot;</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span>
            <span class="n">cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">target_hff_1m</span> <span class="o">=</span> <span class="n">Genomic2DFeatures</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI643OYP9.rebinned.mcool::/resolutions/1000&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;r1000&quot;</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span>
            <span class="n">cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_available</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI9GMP2J8.rebinned.mcool&quot;</span><span class="p">):</span>
        <span class="n">target_h1esc</span> <span class="o">=</span> <span class="n">Genomic2DFeatures</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI9GMP2J8.rebinned.mcool::/resolutions/4000&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;r4000&quot;</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span>
            <span class="n">cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">target_h1esc_256m</span> <span class="o">=</span> <span class="n">Genomic2DFeatures</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI9GMP2J8.rebinned.mcool::/resolutions/32000&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;r32000&quot;</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span>
            <span class="n">cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">target_h1esc_1m</span> <span class="o">=</span> <span class="n">Genomic2DFeatures</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ORCA_PATH</span> <span class="o">+</span> <span class="s2">&quot;/resources/4DNFI9GMP2J8.rebinned.mcool::/resolutions/1000&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;r1000&quot;</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span>
            <span class="n">cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_available</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="genomepredict"><a class="viewcode-back" href="../orca_predict.html#orca_predict.genomepredict">[docs]</a><span class="k">def</span> <span class="nf">genomepredict</span><span class="p">(</span>
    <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mpos</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wpos</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nan_thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiscale prediction for a 32Mb sequence</span>
<span class="sd">    input, zooming into the position specified when generating a series</span>
<span class="sd">    of 32Mb, 16Mb, 8Mb, 4Mb, 2Mb and 1Mb predictions with increasing</span>
<span class="sd">    resolutions (up to 4kb). This function also processes </span>
<span class="sd">    information used only for plotting including targets and annotation.</span>

<span class="sd">    For larger sequence and interchromosomal predictions, you can use </span>
<span class="sd">    256Mb input with genomepredict_256Mb.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequence : numpy.ndarray</span>
<span class="sd">        One-hot sequence encoding of shape 1 x 4 x 32000000. </span>
<span class="sd">        The encoding can be generated with `selene_sdk.Genome.sequence_to_encoding()`.</span>
<span class="sd">    mchr : str</span>
<span class="sd">        Chromosome name. This is used for annotation purpose only.</span>
<span class="sd">    mpos : int, optional</span>
<span class="sd">        The coordinate to zoom into for multiscale prediction.</span>
<span class="sd">    wpos : int, optional</span>
<span class="sd">        The coordinate of the center position of the sequence, which is</span>
<span class="sd">        start position + 16000000.</span>
<span class="sd">    targets : list(numpy.ndarray), optional</span>
<span class="sd">        The observed balanced contact matrices for H1-ESC and HFF from the</span>
<span class="sd">        32Mb region. Used only for plotting when used with genomeplot. </span>
<span class="sd">        The dimensions of the arrays should be 8000 x 8000 (1kb resolution).</span>
<span class="sd">    annotation : str or None, optional</span>
<span class="sd">        List of annotations for plotting. The annotation can be generated with</span>
<span class="sd">        See orca_utils.process_anno and see its documentation for more details.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. If False, use CPU.</span>
<span class="sd">    nan_thresh : int, optional</span>
<span class="sd">        Default is 1. Specify the threshold of the proportion of NaNs values </span>
<span class="sd">        allowed during downsampling for the observed matrices. Only relevant for plotting. </span>
<span class="sd">        The lower resolution observed matrix value are computed by averaging multiple </span>
<span class="sd">        bins into one. By default, we allow missing values and only average over the </span>
<span class="sd">        non-missing values, and the values with more than the specified proprotion </span>
<span class="sd">        of missing values will be filled with NaN.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    output : dict</span>
<span class="sd">        Result dictionary that can be used as input for genomeplot. The dictionary</span>
<span class="sd">        has the following keys:</span>
<span class="sd">            - predictions : list(list(numpy.ndarray), list(numpy.ndarray))</span>
<span class="sd">                Multi-level predictions for H1-ESC and HFF cell types.</span>
<span class="sd">            - experiments : list(list(numpy.ndarray), list(numpy.ndarray))</span>
<span class="sd">                Observations for H1-ESC and HFF cell types that matches the predictions.</span>
<span class="sd">                Exists if `targets` is specified.</span>
<span class="sd">            - normmats : list(list(numpy.ndarray), list(numpy.ndarray))</span>
<span class="sd">                Background distance-based expected balanced contact matrices for </span>
<span class="sd">                H1-ESC and HFF cell types that matches the predictions.</span>
<span class="sd">            - start_coords : list(int)</span>
<span class="sd">                Start coordinates for the prediction at each level.</span>
<span class="sd">            - end_coords : list(int)</span>
<span class="sd">                End coordinates for the prediction at each level.</span>
<span class="sd">            - chr : str</span>
<span class="sd">                The chromosome name.</span>
<span class="sd">            - annos : list(list(...))</span>
<span class="sd">                Annotation information. The format is as outputed by orca_utils.process_anno</span>
<span class="sd">                Exists if `annotation` is specified.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">h1esc</span><span class="p">,</span> <span class="n">hff</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">load_resources</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;32M&quot;</span><span class="p">],</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">h1esc</span><span class="p">,</span> <span class="n">hff</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">allpreds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allstarts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">alltargets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allannos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iii</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">sequence</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">sequence</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="p">(</span><span class="n">encoding1</span><span class="p">,</span> <span class="n">encoding2</span><span class="p">,</span> <span class="n">encoding4</span><span class="p">,</span> <span class="n">encoding8</span><span class="p">,</span> <span class="n">encoding16</span><span class="p">,</span> <span class="n">encoding32</span><span class="p">,)</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">net</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">net0</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">use_cuda</span>
                    <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">net0</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="n">encodings</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">1</span><span class="p">:</span> <span class="n">encoding1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">:</span> <span class="n">encoding2</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">:</span> <span class="n">encoding4</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">:</span> <span class="n">encoding8</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">:</span> <span class="n">encoding16</span><span class="p">,</span>
                    <span class="mi">32</span><span class="p">:</span> <span class="n">encoding32</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">coarse_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">distenc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">normmats</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">use_cuda</span>
                        <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">normmats</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">coarse_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">denets</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                                <span class="n">encodings</span><span class="p">[</span><span class="n">level</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="o">+</span> <span class="mi">250</span>
                                <span class="p">],</span>
                                <span class="n">distenc</span><span class="p">,</span>
                                <span class="n">coarse_pred</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">denet_1_pt</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                                <span class="n">encodings</span><span class="p">[</span><span class="n">level</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="o">+</span> <span class="mi">250</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">denets</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                                <span class="n">encodings</span><span class="p">[</span><span class="n">level</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="o">+</span> <span class="mi">250</span>
                                <span class="p">],</span>
                                <span class="n">distenc</span><span class="p">,</span>
                                <span class="n">coarse_pred</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">denets</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                            <span class="n">encodings</span><span class="p">[</span><span class="n">level</span><span class="p">][:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="n">level</span><span class="p">)</span> <span class="o">+</span> <span class="mi">250</span><span class="p">],</span>
                            <span class="n">distenc</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">return</span> <span class="n">pred</span>

                <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">annos</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">eval_step</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">eval_step</span><span class="p">(</span>
                            <span class="n">level</span><span class="p">,</span>
                            <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                            <span class="n">preds</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span>
                                <span class="p">:,</span>
                                <span class="p">:,</span>
                                <span class="n">start_index</span> <span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">125</span><span class="p">,</span>
                                <span class="n">start_index</span> <span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">125</span><span class="p">,</span>
                            <span class="p">],</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">target_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                    <span class="n">target</span><span class="p">[</span>
                                        <span class="p">:,</span>
                                        <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span><span class="p">,</span>
                                        <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span><span class="p">,</span>
                                    <span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                                    <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span>
                                <span class="p">),</span>
                                <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">target_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                        <span class="n">target</span><span class="p">[</span>
                                            <span class="p">:,</span>
                                            <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span><span class="p">,</span>
                                            <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span><span class="p">,</span>
                                        <span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                                        <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                                <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">target_r</span><span class="p">[</span><span class="n">target_nan</span> <span class="o">&gt;</span> <span class="n">nan_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">target_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">target_r</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">epss</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">normmats</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">epss</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:]</span>
                        <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_np</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">newstart</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mf">8000.0</span>
                        <span class="n">newend</span> <span class="o">=</span> <span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8000.0</span>
                        <span class="n">anno_r</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">newend</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">newstart</span><span class="p">):</span>
                                    <span class="n">anno_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">newend</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">),</span> <span class="mi">0</span><span class="p">,),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">newend</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">),</span> <span class="mi">1</span><span class="p">,),</span>
                                            <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">newstart</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">newend</span><span class="p">:</span>
                                    <span class="n">anno_r</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">newend</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">annos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anno_r</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="p">(</span><span class="n">mpos</span> <span class="o">-</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
                                        <span class="o">-</span> <span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="mi">16000000</span> <span class="o">+</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">)</span>
                                    <span class="p">)</span>
                                    <span class="o">/</span> <span class="p">(</span><span class="mi">4000</span> <span class="o">*</span> <span class="n">level</span><span class="p">)</span>
                                <span class="p">),</span>
                                <span class="mi">0</span><span class="p">,</span>
                                <span class="mi">125</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="mi">16000000</span> <span class="o">-</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">)</span>
                                        <span class="o">-</span> <span class="p">(</span><span class="n">mpos</span> <span class="o">+</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
                                    <span class="p">)</span>
                                    <span class="o">/</span> <span class="p">(</span><span class="mi">4000</span> <span class="o">*</span> <span class="n">level</span><span class="p">)</span>
                                <span class="p">),</span>
                                <span class="mi">0</span><span class="p">,</span>
                                <span class="mi">125</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_index</span> <span class="o">*</span> <span class="n">level</span><span class="p">)</span>
                    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

                <span class="n">allpreds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">targets</span><span class="p">:</span>
                        <span class="n">alltargets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">allannos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annos</span><span class="p">)</span>
                    <span class="n">allstarts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allpreds</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">allpreds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="o">+</span> <span class="n">allpreds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;experiments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alltargets</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;experiments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;start_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="mi">16000000</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">4000</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">allstarts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;end_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;start_coords&quot;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="mi">32000000</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">ii</span><span class="p">))</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;chr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mchr</span>
    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;annos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allannos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;annos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;normmats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">h1esc</span><span class="o">.</span><span class="n">normmats</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">hff</span><span class="o">.</span><span class="n">normmats</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="genomepredict_256Mb"><a class="viewcode-back" href="../orca_predict.html#orca_predict.genomepredict_256Mb">[docs]</a><span class="k">def</span> <span class="nf">genomepredict_256Mb</span><span class="p">(</span>
    <span class="n">sequence</span><span class="p">,</span>
    <span class="n">mchr</span><span class="p">,</span>
    <span class="n">normmats</span><span class="p">,</span>
    <span class="n">chrlen</span><span class="p">,</span>
    <span class="n">mpos</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">wpos</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">nan_thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiscale prediction for a 256Mb sequence</span>
<span class="sd">    input, zooming into the position specified when generating a series</span>
<span class="sd">    of 256Mb, 128Mb, 64Mb, and 32Mb predictions with increasing</span>
<span class="sd">    resolutions (up to 128kb). This function also processes </span>
<span class="sd">    information used only for plotting including targets and annotation.</span>

<span class="sd">    This function accepts multichromosal input sequence. Thus it needs an</span>
<span class="sd">    extra input `normmats` to encode the chromosomal information. See documentation</span>
<span class="sd">    for normmats argument for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequence : numpy.ndarray</span>
<span class="sd">        One-hot sequence encoding of shape 1 x 4 x 256000000. </span>
<span class="sd">        The encoding can be generated with `selene_sdk.Genome.sequence_to_encoding()`.</span>
<span class="sd">    mchr : str</span>
<span class="sd">        The chromosome name of the first chromosome included in the seqeunce. </span>
<span class="sd">        This is used for annotation purpose only.</span>
<span class="sd">    normmats : list(numpy.ndarray)</span>
<span class="sd">        A list of distance-based background matrices for H1-ESC and HFF.The</span>
<span class="sd">        normmats contains arrays with dimensions 8000 x 8000  (32kb resolution). </span>
<span class="sd">        Interchromosomal interactions are filled with the expected balanced contact</span>
<span class="sd">        score for interchromomsal interactions.</span>
<span class="sd">    chrlen : int</span>
<span class="sd">        The coordinate of the end of the first chromosome in the input, which is the </span>
<span class="sd">        chromosome that will be zoomed into.</span>
<span class="sd">    mpos : int, optional</span>
<span class="sd">        Default is -1. The coordinate to zoom into for multiscale prediction. If neither</span>
<span class="sd">        `mpos` nor `wpos` are specified, it zooms into the center of the input by default.</span>
<span class="sd">    wpos : int, optional</span>
<span class="sd">        Default is -1. The coordinate of the center position of the sequence, which is</span>
<span class="sd">        start position + 16000000. If neither `mpos` nor `wpos` are specified, it zooms </span>
<span class="sd">        into the center of the input by default.</span>
<span class="sd">    targets : list(numpy.ndarray), optional</span>
<span class="sd">        Default is None. A list of observed balanced contact matrices for H1-ESC and HFF from the</span>
<span class="sd">        256Mb input, which may include interchromosomal interactions. Used only for </span>
<span class="sd">        plotting when used with genomeplot. The dimensions of the arrays should be </span>
<span class="sd">        8000 x 8000 (32kb resolution).</span>
<span class="sd">    annotation : str or None, optional</span>
<span class="sd">        Default is None. List of annotations for plotting. The annotation can be generated with</span>
<span class="sd">        See orca_utils.process_anno and see its documentation for more details.</span>
<span class="sd">    padding_chr : str, None, optional</span>
<span class="sd">        Default is None. Name of the padding chromosome after the first. Used for annotation</span>
<span class="sd">        only. TODO: be more flexible in the support for multiple chromosomes.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. If False, use CPU.</span>
<span class="sd">    nan_thresh : int, optional</span>
<span class="sd">        Default is 1. Specify the threshold of the proportion of NaNs values </span>
<span class="sd">        allowed during downsampling for the observed matrices. Only relevant for plotting. </span>
<span class="sd">        The lower resolution observed matrix value are computed by averaging multiple </span>
<span class="sd">        bins into one. By default, we allow missing values and only average over the </span>
<span class="sd">        non-missing values, and the values with more than the specified proprotion </span>
<span class="sd">        of missing values will be filled with NaN.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    output : dict</span>
<span class="sd">        Result dictionary that can be used as input for genomeplot. The dictionary</span>
<span class="sd">        has the following keys:</span>
<span class="sd">            - predictions : list(list(numpy.ndarray), list(numpy.ndarray))</span>
<span class="sd">                Multi-level predictions for H1-ESC and HFF cell types.</span>
<span class="sd">            - experiments : list(list(numpy.ndarray), list(numpy.ndarray))</span>
<span class="sd">                Observations for H1-ESC and HFF cell types that matches the predictions.</span>
<span class="sd">                Exists if `targets` is specified.</span>
<span class="sd">            - normmats : list(list(numpy.ndarray), list(numpy.ndarray))</span>
<span class="sd">                Background distance-based expected balanced contact matrices for </span>
<span class="sd">                H1-ESC and HFF cell types that matches the predictions.</span>
<span class="sd">            - start_coords : list(int)</span>
<span class="sd">                Start coordinates for the prediction at each level.</span>
<span class="sd">            - end_coords : list(int)</span>
<span class="sd">                End coordinates for the prediction at each level.</span>
<span class="sd">            - chr : str</span>
<span class="sd">                The chromosome name.</span>
<span class="sd">            - annos : list(list(...))</span>
<span class="sd">                Annotation information. The format is as outputed by orca_utils.process_anno</span>
<span class="sd">                Exists if `annotation` is specified.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">h1esc_256m</span><span class="p">,</span> <span class="n">hff_256m</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">load_resources</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;256M&quot;</span><span class="p">],</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">h1esc_256m</span><span class="p">,</span> <span class="n">hff_256m</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">allpreds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allstarts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allnormmats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">alltargets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allannos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iii</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">sequence</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">sequence</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                <span class="n">normmat</span> <span class="o">=</span> <span class="n">normmats</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">normmat_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">normmat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">normmat_nan</span><span class="p">):</span>
                    <span class="n">normmat</span><span class="p">[</span><span class="n">normmat_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">normmat</span><span class="p">[</span><span class="o">~</span><span class="n">normmat_nan</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

                <span class="p">(</span><span class="n">encoding32</span><span class="p">,</span> <span class="n">encoding64</span><span class="p">,</span> <span class="n">encoding128</span><span class="p">,</span> <span class="n">encoding256</span><span class="p">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">net</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">net1</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">net0</span><span class="p">(</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">use_cuda</span>
                            <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">encodings</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">32</span><span class="p">:</span> <span class="n">encoding32</span><span class="p">,</span>
                    <span class="mi">64</span><span class="p">:</span> <span class="n">encoding64</span><span class="p">,</span>
                    <span class="mi">128</span><span class="p">:</span> <span class="n">encoding128</span><span class="p">,</span>
                    <span class="mi">256</span><span class="p">:</span> <span class="n">encoding256</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">coarse_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">distenc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">use_cuda</span>
                        <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">coarse_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">denets</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                            <span class="n">encodings</span><span class="p">[</span><span class="n">level</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="p">(</span><span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="p">(</span><span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span> <span class="o">+</span> <span class="mi">250</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="n">distenc</span> <span class="k">if</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">distenc</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                            <span class="n">coarse_pred</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">denets</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                            <span class="n">encodings</span><span class="p">[</span><span class="n">level</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="p">(</span><span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="p">(</span><span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span> <span class="o">+</span> <span class="mi">250</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="n">distenc</span> <span class="k">if</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">distenc</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="p">)</span>

                    <span class="k">return</span> <span class="n">pred</span>

                <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">annos</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]):</span>
                    <span class="n">normmat_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="n">normmat</span><span class="p">[</span>
                                    <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span>
                                    <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span>
                                <span class="p">],</span>
                                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span>
                            <span class="p">),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">ns</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">normmat_r</span>

                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">eval_step</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred</span> <span class="o">=</span> <span class="n">eval_step</span><span class="p">(</span>
                            <span class="n">level</span><span class="p">,</span>
                            <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                            <span class="n">preds</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span>
                                <span class="p">:,</span>
                                <span class="p">:,</span>
                                <span class="n">start_index</span> <span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">125</span><span class="p">,</span>
                                <span class="n">start_index</span> <span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">125</span><span class="p">,</span>
                            <span class="p">],</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">target_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                    <span class="n">target</span><span class="p">[</span>
                                        <span class="p">:,</span>
                                        <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span>
                                        <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span>
                                    <span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                                    <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span>
                                <span class="p">),</span>
                                <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">target_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                        <span class="n">target</span><span class="p">[</span>
                                            <span class="p">:,</span>
                                            <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span>
                                            <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">:</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span>
                                        <span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                                        <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,),</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                                <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">target_r</span><span class="p">[</span><span class="n">target_nan</span> <span class="o">&gt;</span> <span class="n">nan_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">normmat_r</span><span class="p">)</span>
                        <span class="n">target_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">target_r</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">normmat_r</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:]</span>
                        <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_np</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">newstart</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mf">8000.0</span>
                        <span class="n">newend</span> <span class="o">=</span> <span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8000.0</span>
                        <span class="n">anno_r</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">newend</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">newstart</span><span class="p">):</span>
                                    <span class="n">anno_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">newend</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">),</span> <span class="mi">0</span><span class="p">,),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">newend</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">),</span> <span class="mi">1</span><span class="p">,),</span>
                                            <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">newstart</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">newend</span><span class="p">:</span>
                                    <span class="n">anno_r</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">newend</span> <span class="o">-</span> <span class="n">newstart</span><span class="p">),</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">annos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anno_r</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">proposed_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpos</span> <span class="o">-</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                            <span class="n">wpos</span> <span class="o">-</span> <span class="mi">128000000</span> <span class="o">+</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span> <span class="o">*</span> <span class="mi">8</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">proposed_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpos</span> <span class="o">-</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                            <span class="n">wpos</span> <span class="o">+</span> <span class="mi">128000000</span> <span class="o">-</span> <span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">1000000</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">chrlen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="mi">0</span> <span class="o">-</span> <span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="mi">128000000</span><span class="p">),</span>
                            <span class="n">chrlen</span> <span class="o">-</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="mi">128000000</span><span class="p">),</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">proposed_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">proposed_start</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">proposed_start</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">proposed_start</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4000</span> <span class="o">*</span> <span class="n">level</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">125</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">iii</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start_index</span> <span class="o">=</span> <span class="mi">250</span> <span class="o">-</span> <span class="p">(</span><span class="n">start_index</span> <span class="o">+</span> <span class="mi">125</span><span class="p">)</span>

                    <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_index</span> <span class="o">*</span> <span class="n">level</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
                    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

                <span class="n">allpreds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
                <span class="n">allnormmats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">targets</span><span class="p">:</span>
                        <span class="n">alltargets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">allannos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annos</span><span class="p">)</span>
                    <span class="n">allstarts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allpreds</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">allpreds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="o">+</span> <span class="n">allpreds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;experiments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alltargets</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;experiments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;start_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="mi">128000000</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">32000</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">allstarts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;end_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;start_coords&quot;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="mi">256000000</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">ii</span><span class="p">)),</span> <span class="n">chrlen</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;annos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allannos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;annos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;chr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mchr</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;padding_chr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">padding_chr</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;normmats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allnormmats</span>
    <span class="k">return</span> <span class="n">output</span></div>


<span class="k">def</span> <span class="nf">_retrieve_multi</span><span class="p">(</span><span class="n">regionlist</span><span class="p">,</span> <span class="n">genome</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normmat_regionlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">regionlist</span>
    <span class="p">]</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">sequences</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
        <span class="n">targets_h1esc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">targets_hff</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">regionlist</span><span class="p">:</span>
            <span class="n">th1esc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">thff</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chrom2</span><span class="p">,</span> <span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span> <span class="n">strand2</span> <span class="ow">in</span> <span class="n">regionlist</span><span class="p">:</span>
                <span class="n">th1esc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">target_h1esc_256m</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">chrom2</span><span class="o">=</span><span class="n">chrom2</span><span class="p">,</span> <span class="n">start2</span><span class="o">=</span><span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="o">=</span><span class="n">end2</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">thff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">target_hff_256m</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">chrom2</span><span class="o">=</span><span class="n">chrom2</span><span class="p">,</span> <span class="n">start2</span><span class="o">=</span><span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="o">=</span><span class="n">end2</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">th1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">th1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">thff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">thff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">strand2</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">th1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">th1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">thff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">thff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">targets_h1esc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th1esc</span><span class="p">)</span>
            <span class="n">targets_hff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thff</span><span class="p">)</span>
        <span class="n">targets_h1esc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">targets_h1esc</span><span class="p">])</span>
        <span class="n">targets_hff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">targets_hff</span><span class="p">])</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">targets_h1esc</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">targets_hff</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span>
        <span class="p">]</span>
    <span class="k">if</span> <span class="n">normmat</span><span class="p">:</span>
        <span class="n">normmats_h1esc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">normmats_hff</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">normmat_regionlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">normmat_regionlist</span> <span class="o">=</span> <span class="n">regionlist</span>
        <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">normmat_regionlist</span><span class="p">:</span>
            <span class="n">bh1esc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bhff</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chrom2</span><span class="p">,</span> <span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span> <span class="n">strand2</span> <span class="ow">in</span> <span class="n">normmat_regionlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">chrom2</span> <span class="o">!=</span> <span class="n">chrom</span><span class="p">:</span>
                    <span class="n">bh1esc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                            <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">end2</span> <span class="o">-</span> <span class="n">start2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">)),</span>
                            <span class="n">h1esc_256m</span><span class="o">.</span><span class="n">background_trans</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">bhff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                            <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">end2</span> <span class="o">-</span> <span class="n">start2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">)),</span>
                            <span class="n">hff_256m</span><span class="o">.</span><span class="n">background_trans</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">binsize</span> <span class="o">=</span> <span class="mi">32000</span>
                    <span class="n">acoor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bcoor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">end2</span> <span class="o">-</span> <span class="n">start2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bh1esc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">h1esc_256m</span><span class="o">.</span><span class="n">background_cis</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">acoor</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">bcoor</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">bhff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">hff_256m</span><span class="o">.</span><span class="n">background_cis</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">acoor</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">bcoor</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                        <span class="n">bh1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bh1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">bhff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bhff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">if</span> <span class="n">strand2</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                        <span class="n">bh1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bh1esc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">bhff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bhff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">normmats_h1esc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bh1esc</span><span class="p">)</span>
            <span class="n">normmats_hff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bhff</span><span class="p">)</span>
        <span class="n">normmats_h1esc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">normmats_h1esc</span><span class="p">])</span>
        <span class="n">normmats_hff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">normmats_hff</span><span class="p">])</span>
        <span class="n">normmats</span> <span class="o">=</span> <span class="p">[</span><span class="n">normmats_h1esc</span><span class="p">,</span> <span class="n">normmats_hff</span><span class="p">]</span>

    <span class="n">datatuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">normmat</span><span class="p">:</span>
        <span class="n">datatuple</span> <span class="o">=</span> <span class="n">datatuple</span> <span class="o">+</span> <span class="p">(</span><span class="n">normmats</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
        <span class="n">datatuple</span> <span class="o">=</span> <span class="n">datatuple</span> <span class="o">+</span> <span class="p">(</span><span class="n">targets</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">datatuple</span>


<div class="viewcode-block" id="process_region"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_region">[docs]</a><span class="k">def</span> <span class="nf">process_region</span><span class="p">(</span>
    <span class="n">mchr</span><span class="p">,</span>
    <span class="n">mstart</span><span class="p">,</span>
    <span class="n">mend</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for </span>
<span class="sd">    the specified region. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mchr : str</span>
<span class="sd">        The chromosome name of the first segment</span>
<span class="sd">    mstart : int</span>
<span class="sd">        The start coordinate of the region.</span>
<span class="sd">    mend : ind</span>
<span class="sd">        The end coordinate of the region.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. The acceptable values are 16000000 which selects</span>
<span class="sd">        the 1-32Mb models or 128000000 which selects the 32-256Mb models.</span>
<span class="sd">    padding_chr : str, optional</span>
<span class="sd">        Default is &quot;chr1&quot;. If window_radius is 128000000, padding is generally </span>
<span class="sd">        needed to fill the sequence to 256Mb. The padding sequence will be </span>
<span class="sd">        extracted from the padding_chr.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref_l, outputs_ref_r, outputs_alt : dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the left boundary of the</span>
<span class="sd">        duplication,</span>
<span class="sd">        Reference allele predictions zooming into the right boundary of the</span>
<span class="sd">        duplication,</span>
<span class="sd">        Alternative allele predictions zooming into the duplication breakpoint.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">mchr</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">mpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">mstart</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">mend</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mpos</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen_round</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="n">chrlen</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Only window_radius 16000000 (32Mb models) or 128000000 (256Mb models) are supported&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">mstart</span> <span class="o">-</span> <span class="n">mend</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mpos</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mpos</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs_ref</span></div>


<div class="viewcode-block" id="process_dup"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_dup">[docs]</a><span class="k">def</span> <span class="nf">process_dup</span><span class="p">(</span>
    <span class="n">mchr</span><span class="p">,</span>
    <span class="n">mstart</span><span class="p">,</span>
    <span class="n">mend</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for </span>
<span class="sd">    an duplication variant. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mchr : str</span>
<span class="sd">        The chromosome name of the first segment</span>
<span class="sd">    mstart : int</span>
<span class="sd">        The start coordinate of the duplication.</span>
<span class="sd">    mend : ind</span>
<span class="sd">        The end coordinate of the duplication.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. The acceptable values are 16000000 which selects</span>
<span class="sd">        the 1-32Mb models or 128000000 which selects the 32-256Mb models.</span>
<span class="sd">    padding_chr : str, optional</span>
<span class="sd">        Default is &quot;chr1&quot;. If window_radius is 128000000, padding is generally </span>
<span class="sd">        needed to fill the sequence to 256Mb. The padding sequence will be </span>
<span class="sd">        extracted from the padding_chr.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref_l, outputs_ref_r, outputs_alt : dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the left boundary of the</span>
<span class="sd">        duplication,</span>
<span class="sd">        Reference allele predictions zooming into the right boundary of the</span>
<span class="sd">        duplication,</span>
<span class="sd">        Alternative allele predictions zooming into the duplication breakpoint.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">mchr</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="c1"># ref.l</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen_round</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="n">chrlen</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Only window_radius 16000000 (32Mb models) or 128000000 (256Mb models) are supported&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span> <span class="o">&gt;</span> <span class="n">mend</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.l.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.l.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># ref.r</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="o">&lt;</span> <span class="n">mstart</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_ref_r</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_r</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.r.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_r</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mend</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">genomeplot_256Mb</span><span class="p">(</span>
            <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.r.256m.pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># alt (r)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StructuralChange2</span><span class="p">(</span><span class="n">mchr</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">)</span>
    <span class="n">chrlen_alt</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">+</span> <span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">chrlen_alt</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chrlen_alt_round</span> <span class="o">=</span> <span class="n">chrlen_alt</span> <span class="o">-</span> <span class="n">chrlen_alt</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="k">if</span> <span class="n">chrlen_alt_round</span> <span class="o">&lt;</span> <span class="mi">256000000</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">chrlen_alt_round</span><span class="p">])</span> <span class="o">+</span> <span class="p">[[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="mi">128000000</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]),</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="o">&lt;</span> <span class="n">mstart</span> <span class="ow">and</span> <span class="n">mend</span> <span class="o">+</span> <span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span> <span class="o">&lt;</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">mend</span><span class="p">,</span> <span class="n">mend</span> <span class="o">+</span> <span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="o">&gt;=</span> <span class="n">mstart</span> <span class="ow">and</span> <span class="n">mend</span> <span class="o">+</span> <span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span> <span class="o">&lt;</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">mend</span><span class="p">,</span> <span class="n">mend</span> <span class="o">+</span> <span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">],],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="o">&lt;</span> <span class="n">mstart</span> <span class="ow">and</span> <span class="n">mend</span> <span class="o">+</span> <span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span> <span class="o">&gt;=</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">],],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_alt_round</span><span class="p">,</span>
            <span class="n">mend</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">outputs_alt</span></div>


<div class="viewcode-block" id="process_del"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_del">[docs]</a><span class="k">def</span> <span class="nf">process_del</span><span class="p">(</span>
    <span class="n">mchr</span><span class="p">,</span>
    <span class="n">mstart</span><span class="p">,</span>
    <span class="n">mend</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for </span>
<span class="sd">    an deletion variant. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mchr : str</span>
<span class="sd">        The chromosome name of the first segment</span>
<span class="sd">    mstart : int</span>
<span class="sd">        The start coordinate of the deletion.</span>
<span class="sd">    mend : ind</span>
<span class="sd">        The end coordinate of the deletion.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. The acceptable values are 16000000 which selects</span>
<span class="sd">        the 1-32Mb models or 128000000 which selects the 32-256Mb models.</span>
<span class="sd">    padding_chr : str, optional</span>
<span class="sd">        Default is &quot;chr1&quot;. If window_radius is 128000000, padding is generally </span>
<span class="sd">        needed to fill the sequence to 256Mb. The padding sequence will be </span>
<span class="sd">        extracted from the padding_chr.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref_l, outputs_ref_r, outputs_alt : dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the left boundary of the</span>
<span class="sd">        deletion,</span>
<span class="sd">        Reference allele predictions zooming into the right boundary of the</span>
<span class="sd">        deletion,</span>
<span class="sd">        Alternative allele predictions zooming into the deletion breakpoint.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">mchr</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="c1"># ref.l</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen_round</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="n">chrlen</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Only window_radius 16000000 (32Mb models) or 128000000 (256Mb models) are supported&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span> <span class="o">&gt;</span> <span class="n">mend</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.l.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.l.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># ref.r</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="o">&lt;</span> <span class="n">mstart</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_ref_r</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_r</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.r.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_r</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mend</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.r.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># alt</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StructuralChange2</span><span class="p">(</span><span class="n">mchr</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">)</span>
    <span class="n">chrlen_alt</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="p">(</span><span class="n">mend</span> <span class="o">-</span> <span class="n">mstart</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">chrlen_alt</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chrlen_alt_round</span> <span class="o">=</span> <span class="n">chrlen_alt</span> <span class="o">-</span> <span class="n">chrlen_alt</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">chrlen_alt_round</span><span class="p">])</span> <span class="o">+</span> <span class="p">[[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
            <span class="n">genome</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[</span>
                <span class="p">[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_alt_round</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">outputs_alt</span></div>


<div class="viewcode-block" id="process_inv"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_inv">[docs]</a><span class="k">def</span> <span class="nf">process_inv</span><span class="p">(</span>
    <span class="n">mchr</span><span class="p">,</span>
    <span class="n">mstart</span><span class="p">,</span>
    <span class="n">mend</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for </span>
<span class="sd">    an inversion variant. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mchr : str</span>
<span class="sd">        The chromosome name of the first segment</span>
<span class="sd">    mstart : int</span>
<span class="sd">        The start coordinate of the inversion.</span>
<span class="sd">    mend : ind</span>
<span class="sd">        The end coordinate of the inversion.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. The acceptable values are 16000000 which selects</span>
<span class="sd">        the 1-32Mb models or 128000000 which selects the 32-256Mb models.</span>
<span class="sd">    padding_chr : str, optional</span>
<span class="sd">        Default is &quot;chr1&quot;. If window_radius is 128000000, padding is generally </span>
<span class="sd">        needed to fill the sequence to 256Mb. The padding sequence will be </span>
<span class="sd">        extracted from the padding_chr.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref_l, outputs_ref_r, outputs_alt_l, outputs_alt_r : dict, dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the left boundary of the</span>
<span class="sd">        inversion,</span>
<span class="sd">        Reference allele predictions zooming into the right boundary of the</span>
<span class="sd">        inversion,</span>
<span class="sd">        Alternative allele predictions zooming into the left boundary of </span>
<span class="sd">        the inversion,</span>
<span class="sd">        Alternative allele prediction zooming into the right boundary of </span>
<span class="sd">        the inversion.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">mchr</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen_round</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="n">chrlen</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Only window_radius 16000000 (32Mb models) or 128000000 (256Mb models) are supported&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span> <span class="o">&gt;</span> <span class="n">mend</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.l.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.l.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># ref.r</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">mchr</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="o">&lt;</span> <span class="n">mstart</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_ref_r</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_r</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.r.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_r</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mend</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.r.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># alt.l</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StructuralChange2</span><span class="p">(</span><span class="n">mchr</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mstart</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="p">(</span><span class="n">sequence</span><span class="p">,)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">chrlen_round</span><span class="p">])</span> <span class="o">+</span> <span class="p">[[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
            <span class="n">genome</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">normmat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># normmats are not changed for inversion</span>

    <span class="k">if</span> <span class="n">mend</span> <span class="o">&lt;</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt_l</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mstart</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.l.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt_l</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mstart</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.l.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mend</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mstart</span> <span class="o">&gt;</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mstart</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt_r</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mend</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt_r</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.r.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt_r</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mend</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt_r</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.r.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">outputs_alt_r</span></div>


<div class="viewcode-block" id="process_ins"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_ins">[docs]</a><span class="k">def</span> <span class="nf">process_ins</span><span class="p">(</span>
    <span class="n">mchr</span><span class="p">,</span>
    <span class="n">mpos</span><span class="p">,</span>
    <span class="n">ins_seq</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">strand</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for </span>
<span class="sd">    an insertion variant that inserts the specified sequence </span>
<span class="sd">    to the insertion site. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mchr : str</span>
<span class="sd">        The chromosome name of the first segment</span>
<span class="sd">    mpos : int</span>
<span class="sd">        The insertion site coordinate.</span>
<span class="sd">    ins_seq : str</span>
<span class="sd">        The inserted sequence in string format.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. The acceptable values are 16000000 which selects</span>
<span class="sd">        the 1-32Mb models or 128000000 which selects the 32-256Mb models.</span>
<span class="sd">    padding_chr : str, optional</span>
<span class="sd">        Default is &quot;chr1&quot;. If window_radius is 128000000, padding is generally </span>
<span class="sd">        needed to fill the sequence to 256Mb. The padding sequence will be </span>
<span class="sd">        extracted from the padding_chr.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref, outputs_alt_l, outputs_alt_r : dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the insertion site,</span>
<span class="sd">        Alternative allele predictions zooming into the left boundary of </span>
<span class="sd">        the insertion seqeunce,</span>
<span class="sd">        Alternative allele prediction zooming into the right boundary of </span>
<span class="sd">        the insertion seqeunce.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">mchr</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mpos</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">mchr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span>
                        <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">mchr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span>
                        <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen_round</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="n">chrlen</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Only window_radius 16000000 (32Mb models) or 128000000 (256Mb models) are supported&quot;</span>
        <span class="p">)</span>

    <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">mpos</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref_l</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_round</span><span class="p">,</span>
            <span class="n">mpos</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mpos</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># alt</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StructuralChange2</span><span class="p">(</span><span class="n">mchr</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mpos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span>
    <span class="n">chrlen_alt</span> <span class="o">=</span> <span class="n">chrlen</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mpos</span><span class="p">,</span> <span class="n">chrlen_alt</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chr_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">chr_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ins&quot;</span><span class="p">):</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">Genome</span><span class="o">.</span><span class="n">sequence_to_encoding</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chr_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chrlen_alt_round</span> <span class="o">=</span> <span class="n">chrlen_alt</span> <span class="o">-</span> <span class="n">chrlen_alt</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="k">if</span> <span class="n">chrlen_alt_round</span> <span class="o">&lt;</span> <span class="mi">256000000</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">chrlen_alt_round</span><span class="p">])</span> <span class="o">+</span> <span class="p">[[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">[</span><span class="n">mchr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mpos</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="mi">128000000</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]),</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mpos</span><span class="p">,</span> <span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mpos</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt_l</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mpos</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.l.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt_l</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_alt_round</span><span class="p">,</span>
            <span class="n">mpos</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.l.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="n">chrlen_alt</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chr_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">chr_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ins&quot;</span><span class="p">):</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">Genome</span><span class="o">.</span><span class="n">sequence_to_encoding</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chr_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">chrlen_alt_round</span> <span class="o">&gt;</span> <span class="mi">256000000</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="mi">128000000</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]),</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[[</span><span class="n">mchr</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">mpos</span> <span class="o">&gt;</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">mpos</span><span class="p">,</span> <span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="s2">&quot;gray&quot;</span><span class="p">]],</span>
            <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt_r</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">mchr</span><span class="p">,</span> <span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt_r</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.r.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">mchr</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_alt_round</span><span class="p">,</span>
            <span class="n">mpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_seq</span><span class="p">),</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.r.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs_ref</span><span class="p">,</span> <span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">outputs_alt_r</span></div>


<div class="viewcode-block" id="process_custom"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_custom">[docs]</a><span class="k">def</span> <span class="nf">process_custom</span><span class="p">(</span>
    <span class="n">region_list</span><span class="p">,</span>
    <span class="n">ref_region_list</span><span class="p">,</span>
    <span class="n">mpos</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">ref_mpos_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">anno_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ref_anno_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for </span>
<span class="sd">    a custom variant by an ordered list of genomic segments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    region_list : list(list(...))</span>
<span class="sd">        List of segments to complete the alternative. Each segment is specified</span>
<span class="sd">        by a list( chr: str, start: int, end: int, strand: str), and segments</span>
<span class="sd">        are concatenated together in the given order. The total length </span>
<span class="sd">        should sum up to 32Mb. An example input is</span>
<span class="sd">        [[&#39;chr5&#39;, 89411065, 89411065+16000000, &#39;-&#39;], [&#39;chr7&#39;, 94378248, 94378248+16000000,&#39;+&#39;]].</span>
<span class="sd">    ref_region_list : list(list(...))</span>
<span class="sd">        The reference regions to predict. This can be any reference regions with</span>
<span class="sd">        the length of the specified window size. If the Each reference region is specified</span>
<span class="sd">        with a list( chr: str, start: int, end: int, strand: str). The strand must</span>
<span class="sd">        be &#39;+&#39;. The intended use is predicting the genome interactions for each </span>
<span class="sd">        segment that constitute the alternative allele within the native</span>
<span class="sd">        reference sequence context. An example</span>
<span class="sd">        input is [[&#39;chr5&#39;, 89411065-16000000, 89411065+16000000,&#39;+&#39;],</span>
<span class="sd">        [&#39;chr7&#39;, 94378248-16000000, 94378248+16000000,&#39;+&#39;]].</span>
<span class="sd">    mpos : int</span>
<span class="sd">        The position to zoom into in the alternative allele. Note that `mpos`</span>
<span class="sd">        here specify the relative position with respect to the to start of the 32Mb.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from.</span>
<span class="sd">    ref_mpos_list : list(int) or None, optional</span>
<span class="sd">        Default is None. List of positions to zoom into for each of the </span>
<span class="sd">        reference regions specified in `ref_region_list`. If not specified, </span>
<span class="sd">        then zoom into the center of each region. Note that `ref_mpos_list`</span>
<span class="sd">        specifies the relative positions with respect to start of the 32Mb. </span>
<span class="sd">        For example, `16000000` means the center of the sequence.</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. Currently only 16000000 (32Mb window) is accepted.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref_l, outputs_ref_r, outputs_alt : dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the left boundary of the</span>
<span class="sd">        duplication,</span>
<span class="sd">        Reference allele predictions zooming into the right boundary of the</span>
<span class="sd">        duplication,</span>
<span class="sd">        Alternative allele predictions zooming into the duplication breakpoint.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate_region_list</span><span class="p">(</span><span class="n">region_list</span><span class="p">,</span> <span class="n">enforce_strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sumlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">region_list</span><span class="p">:</span>
            <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">chrm</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">chrlen</span>
            <span class="n">sumlen</span> <span class="o">+=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="k">if</span> <span class="n">enforce_strand</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">strand</span> <span class="o">!=</span> <span class="n">enforce_strand</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The specified strand must be &quot;</span> <span class="o">+</span> <span class="n">enforce_strand</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">sumlen</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">window_radius</span>

    <span class="n">validate_region_list</span><span class="p">(</span><span class="n">region_list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ref_region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref_region_list</span><span class="p">):</span>
        <span class="n">validate_region_list</span><span class="p">([</span><span class="n">ref_region</span><span class="p">],</span> <span class="n">enforce_strand</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">ref_sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="o">*</span><span class="n">ref_region</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">ref_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">ref_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">ref_region</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">ref_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">ref_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">ref_region</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span><span class="n">ref_anno_list</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">)</span>

        <span class="n">outputs_ref</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">ref_sequence</span><span class="p">,</span>
            <span class="n">ref_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">ref_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">window_radius</span> <span class="k">if</span> <span class="n">ref_mpos_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref_mpos_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">ref_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">region_list</span><span class="p">:</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    <span class="n">alt_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span><span class="n">anno_list</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">)</span>

    <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
        <span class="n">alt_sequence</span><span class="p">,</span> <span class="s2">&quot;chimeric&quot;</span><span class="p">,</span> <span class="n">mpos</span><span class="p">,</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.pdf&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs_ref</span><span class="p">,</span> <span class="n">outputs_alt</span></div>


<div class="viewcode-block" id="process_single_breakpoint"><a class="viewcode-back" href="../orca_predict.html#orca_predict.process_single_breakpoint">[docs]</a><span class="k">def</span> <span class="nf">process_single_breakpoint</span><span class="p">(</span>
    <span class="n">chr1</span><span class="p">,</span>
    <span class="n">pos1</span><span class="p">,</span>
    <span class="n">chr2</span><span class="p">,</span>
    <span class="n">pos2</span><span class="p">,</span>
    <span class="n">orientation1</span><span class="p">,</span>
    <span class="n">orientation2</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_tracks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">window_radius</span><span class="o">=</span><span class="mi">16000000</span><span class="p">,</span>
    <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
    <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate multiscale genome interaction predictions for</span>
<span class="sd">    a simple translocation event that connects </span>
<span class="sd">    two chromosomal breakpoints. Specifically, two breakpoint </span>
<span class="sd">    positions and the corresponding two orientations are needed. </span>
<span class="sd">    The orientations decide how the breakpoints are connected. </span>
<span class="sd">    The + or - sign indicate whether the left or right side of </span>
<span class="sd">    the breakpoint is used. For example, for an input </span>
<span class="sd">    (&#39;chr1&#39;, 85691449, &#39;chr5&#39;, 89533745 &#39;+&#39;, &#39;+&#39;), two plus signs</span>
<span class="sd">    indicate connecting chr1:0-85691449 with chr5:0-89533745.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chr1 : str</span>
<span class="sd">        The chromosome name of the first segment</span>
<span class="sd">    pos1 : int</span>
<span class="sd">        The coorindate of breakpoint on the first segment</span>
<span class="sd">    chr2 : str</span>
<span class="sd">        The chromosome name of the second segment</span>
<span class="sd">    pos2 : int</span>
<span class="sd">        The coorindate of breakpoint on the second segment</span>
<span class="sd">    orientation1 : str</span>
<span class="sd">        Indicate which side of the breakpoint should be used for</span>
<span class="sd">        the first segment,</span>
<span class="sd">        &#39;+&#39; indicate the left and &#39;-&#39; indicate the right side.</span>
<span class="sd">    orientation2 : str</span>
<span class="sd">        Indicate which side of the breakpoint should be used for</span>
<span class="sd">        the second segment,</span>
<span class="sd">        &#39;+&#39; indicate the left and &#39;-&#39; indicate the right side.</span>
<span class="sd">    genome : selene_utils2.MemmapGenome or selene_sdk.sequences.Genome</span>
<span class="sd">        The reference genome object to extract sequence from</span>
<span class="sd">    target : bool, optional</span>
<span class="sd">        Default is True. If True, retrieve micro-C data for H1-ESC</span>
<span class="sd">        and HFF cells (4DNFI9GMP2J8, 4DNFI643OYP9).</span>
<span class="sd">    file : str or None, optional</span>
<span class="sd">        Default is None. The output file prefix.</span>
<span class="sd">    show_genes : bool, optional</span>
<span class="sd">        Default is True. If True, generate gene annotation visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    show_tracks : bool, optional</span>
<span class="sd">        Default is False. If True, generate chromatin tracks visualization</span>
<span class="sd">        file in pdf format that matches the windows of multiscale predictions.</span>
<span class="sd">    window_radius : int, optional</span>
<span class="sd">        Default is 16000000. The acceptable values are 16000000 which selects</span>
<span class="sd">        the 1-32Mb models or 128000000 which selects the 32-256Mb models.</span>
<span class="sd">    padding_chr : str, optional</span>
<span class="sd">        Default is &quot;chr1&quot;. If window_radius is 128000000, padding is generally </span>
<span class="sd">        needed to fill the sequence to 256Mb. The padding sequence will be </span>
<span class="sd">        extracted from the padding_chr.</span>
<span class="sd">    use_cuda : bool, optional</span>
<span class="sd">        Default is True. Use CPU if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs_ref_1, outputs_ref_2, outputs_alt : dict, dict, dict</span>
<span class="sd">        Reference allele predictions zooming into the chr1 breakpoint,</span>
<span class="sd">        Reference allele predictions zooming into the chr2 breakpoint,</span>
<span class="sd">        Alternative allele prediction zooming into the junction.</span>
<span class="sd">        The returned results are in the format of dictonaries </span>
<span class="sd">        containing the prediction outputs and other </span>
<span class="sd">        retrieved information. These dictionaries can be directly used as</span>
<span class="sd">        input to genomeplot or genomeplot_256Mb. See documentation of `genomepredict` or `genomepredict_256Mb` for</span>
<span class="sd">        details of the dictionary content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrlen1</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">chr1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="c1"># ref.l</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">chrlen1</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">chr1</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">chr1</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">chr1</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen1_round</span> <span class="o">=</span> <span class="n">chrlen1</span> <span class="o">-</span> <span class="n">chrlen1</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">chr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen1_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen1_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">chr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen1_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen1_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Only window_radius 16000000 (32Mb models) or 128000000 (256Mb models) are supported&quot;</span>
        <span class="p">)</span>

    <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">pos1</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref_1</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">chr1</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen1_round</span><span class="p">,</span>
            <span class="n">pos1</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_1</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">chr1</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_1</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.1.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_1</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.1.pdf&quot;</span><span class="p">,</span>
                <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">chrlen2</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">chr2</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span> <span class="n">chrlen2</span><span class="p">)</span>

        <span class="n">sequence</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span>
            <span class="n">chr2</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span>
        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_h1esc</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">chr2</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                    <span class="n">target_hff</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">(</span>
                        <span class="n">chr2</span><span class="p">,</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">),</span> <span class="n">coord_round</span><span class="p">(</span><span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">),</span>
                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">chrlen2_round</span> <span class="o">=</span> <span class="n">chrlen2</span> <span class="o">-</span> <span class="n">chrlen2</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">target_available</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">chr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen2_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen2_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">chr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen2_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen2_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">pos2</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
        <span class="n">outputs_ref_2</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">chr2</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen2_round</span><span class="p">,</span>
            <span class="n">pos2</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_ref_2</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">chr2</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">128000000</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_ref_2</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.2.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span>
                <span class="n">outputs_ref_2</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.ref.2.pdf&quot;</span><span class="p">,</span>
                <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">chr1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StructuralChange2</span><span class="p">(</span><span class="n">chr1</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orientation1</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chrlen</span> <span class="o">-</span> <span class="n">pos1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">chrlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_chr_lens</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">chr2</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">StructuralChange2</span><span class="p">(</span><span class="n">chr2</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orientation2</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span> <span class="n">chrlen</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos2</span><span class="p">)</span>

    <span class="n">breakpos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coord_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">s2</span>

    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">breakpos</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">coord_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curpos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">get_encoding_from_coords</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="n">anno</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">curpos</span><span class="p">,</span> <span class="n">curpos</span> <span class="o">+</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">])</span>
            <span class="n">curpos</span> <span class="o">=</span> <span class="n">curpos</span> <span class="o">+</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chrlen_alt_round</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coord_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coord_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">32000</span>
        <span class="k">if</span> <span class="n">chrlen_alt_round</span> <span class="o">&lt;</span> <span class="mi">256000000</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="mi">128000000</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">chrlen_alt_round</span><span class="p">])</span> <span class="o">+</span> <span class="p">[[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]],</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">[</span><span class="n">chr1</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">chr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">padding_chr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256000000</span> <span class="o">-</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">],</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">curpos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">anno</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">chrlen_alt_round</span><span class="p">]:</span>
                <span class="n">anno</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">curpos</span><span class="p">,</span> <span class="n">curpos</span> <span class="o">+</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">])</span>
                <span class="n">curpos</span> <span class="o">=</span> <span class="n">curpos</span> <span class="o">+</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wpos</span> <span class="o">=</span> <span class="n">coord_clip</span><span class="p">(</span><span class="n">breakpos</span><span class="p">,</span> <span class="n">chrlen_alt_round</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="mi">128000000</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">normmats</span><span class="p">)</span> <span class="o">=</span> <span class="n">_retrieve_multi</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]),</span>
                <span class="n">genome</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">normmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normmat_regionlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">[</span><span class="n">chr1</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">chr2</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span><span class="p">,</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">]</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">curpos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">anno</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">wpos</span> <span class="o">-</span> <span class="n">window_radius</span> <span class="p">:</span> <span class="n">wpos</span> <span class="o">+</span> <span class="n">window_radius</span><span class="p">]:</span>
                <span class="n">anno</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">curpos</span><span class="p">,</span> <span class="n">curpos</span> <span class="o">+</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">])</span>
                <span class="n">curpos</span> <span class="o">=</span> <span class="n">curpos</span> <span class="o">+</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">anno_scaled</span> <span class="o">=</span> <span class="n">process_anno</span><span class="p">([[</span><span class="n">anno</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;double&quot;</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window_radius</span> <span class="o">==</span> <span class="mi">16000000</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="n">chr1</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">chr2</span><span class="p">,</span> <span class="n">breakpos</span><span class="p">,</span> <span class="n">wpos</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot</span><span class="p">(</span><span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.pdf&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">genomepredict_256Mb</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span>
            <span class="n">chr1</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">chr2</span><span class="p">,</span>
            <span class="n">normmats</span><span class="p">,</span>
            <span class="n">chrlen_alt_round</span><span class="p">,</span>
            <span class="n">breakpos</span><span class="p">,</span>
            <span class="n">wpos</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="n">anno_scaled</span><span class="p">,</span>
            <span class="n">padding_chr</span><span class="o">=</span><span class="n">padding_chr</span><span class="p">,</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">genomeplot_256Mb</span><span class="p">(</span>
                <span class="n">outputs_alt</span><span class="p">,</span> <span class="n">show_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.alt.256m.pdf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs_ref_1</span><span class="p">,</span> <span class="n">outputs_ref_2</span><span class="p">,</span> <span class="n">outputs_alt</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">docopt</span> <span class="k">import</span> <span class="n">docopt</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Orca multiscale genome interaction sequence model prediction tool.</span>

<span class="s2">    Usage:</span>
<span class="s2">    orca_predict region [options] &lt;coordinate&gt; &lt;output_dir&gt;</span>
<span class="s2">    orca_predict del [options] &lt;coordinate&gt; &lt;output_dir&gt;</span>
<span class="s2">    orca_predict dup [options] &lt;coordinate&gt; &lt;output_dir&gt;</span>
<span class="s2">    orca_predict inv [options] &lt;coordinate&gt; &lt;output_dir&gt;</span>
<span class="s2">    orca_predict break [options] &lt;coordinate&gt; &lt;output_dir&gt;</span>

<span class="s2">    Options:</span>
<span class="s2">    -h --help       Show this screen.</span>
<span class="s2">    --show_genes    Show gene annotation (only supported for 32Mb models).</span>
<span class="s2">    --show_tracks   Show chromatin tracks (only supported for 32Mb models).</span>
<span class="s2">    --256m          Use 256Mb models (default is 32Mb).</span>
<span class="s2">    --nocuda        Use CPU implementation. </span>
<span class="s2">    --version       Show version.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;Orca v0.1&quot;</span><span class="p">)</span>
    <span class="n">show_genes</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;--show_genes&quot;</span><span class="p">]</span>
    <span class="n">show_tracks</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;--show_tracks&quot;</span><span class="p">]</span>
    <span class="n">window_radius</span> <span class="o">=</span> <span class="mi">128000000</span> <span class="k">if</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;--256m&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">16000000</span>
    <span class="n">use_cuda</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;--nocuda&quot;</span><span class="p">]</span>

    <span class="n">load_resources</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;32M&quot;</span><span class="p">],</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]:</span>
        <span class="n">predtype</span> <span class="o">=</span> <span class="s2">&quot;region&quot;</span>
    <span class="k">elif</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;del&quot;</span><span class="p">]:</span>
        <span class="n">predtype</span> <span class="o">=</span> <span class="s2">&quot;del&quot;</span>
    <span class="k">elif</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;dup&quot;</span><span class="p">]:</span>
        <span class="n">predtype</span> <span class="o">=</span> <span class="s2">&quot;dup&quot;</span>
    <span class="k">elif</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;inv&quot;</span><span class="p">]:</span>
        <span class="n">predtype</span> <span class="o">=</span> <span class="s2">&quot;inv&quot;</span>
    <span class="k">elif</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;break&quot;</span><span class="p">]:</span>
        <span class="n">predtype</span> <span class="o">=</span> <span class="s2">&quot;break&quot;</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">savedir</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savedir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savedir</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">process_region</span><span class="p">(</span>
                <span class="n">chrm</span><span class="p">,</span>
                <span class="n">start</span><span class="p">,</span>
                <span class="n">end</span><span class="p">,</span>
                <span class="n">hg38</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target_available</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred&quot;</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
                <span class="n">padding_chr</span><span class="o">=</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span>
                <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred.pth&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_interactions</span><span class="p">(</span><span class="n">predtype</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">savedir</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">predtype</span> <span class="o">==</span> <span class="s2">&quot;region&quot;</span><span class="p">:</span>
            <span class="n">pdf_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orca_pred.pdf&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">show_genes</span> <span class="ow">or</span> <span class="n">show_tracks</span><span class="p">:</span>
                <span class="n">pdf_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;orca_pred.anno.pdf&quot;</span><span class="p">]</span>
            <span class="n">chrstr</span><span class="p">,</span> <span class="n">coordstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">chrstr</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">chrstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">coord_s</span><span class="p">,</span> <span class="n">coord_e</span> <span class="o">=</span> <span class="n">coordstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">predict</span><span class="p">(</span><span class="n">chrstr</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">coord_s</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">coord_e</span><span class="p">),</span> <span class="n">savedir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">predtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dup&quot;</span><span class="p">,</span> <span class="s2">&quot;del&quot;</span><span class="p">]:</span>
            <span class="n">pdf_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orca_pred.ref.l.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;orca_pred.ref.r.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;orca_pred.alt.pdf&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">show_genes</span> <span class="ow">or</span> <span class="n">show_tracks</span><span class="p">:</span>
                <span class="n">pdf_names</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s2">&quot;orca_pred.ref.l.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.ref.r.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.alt.anno.pdf&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="n">chrstr</span><span class="p">,</span> <span class="n">coordstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">chrstr</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">chrstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">coord_s</span><span class="p">,</span> <span class="n">coord_e</span> <span class="o">=</span> <span class="n">coordstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savedir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savedir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">predtype</span> <span class="o">==</span> <span class="s2">&quot;dup&quot;</span><span class="p">:</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">process_dup</span><span class="p">(</span>
                    <span class="n">chrstr</span><span class="p">,</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">coord_s</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">coord_e</span><span class="p">),</span>
                    <span class="n">hg38</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target_available</span><span class="p">,</span>
                    <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                    <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred&quot;</span><span class="p">,</span>
                    <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
                    <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">process_del</span><span class="p">(</span>
                    <span class="n">chrstr</span><span class="p">,</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">coord_s</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">coord_e</span><span class="p">),</span>
                    <span class="n">hg38</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target_available</span><span class="p">,</span>
                    <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                    <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred&quot;</span><span class="p">,</span>
                    <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
                    <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;outputs_ref_l&quot;</span><span class="p">:</span> <span class="n">outputs_ref_l</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_ref_r&quot;</span><span class="p">:</span> <span class="n">outputs_ref_r</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_alt&quot;</span><span class="p">:</span> <span class="n">outputs_alt</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred.pth&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">predtype</span> <span class="o">==</span> <span class="s2">&quot;inv&quot;</span><span class="p">:</span>
            <span class="n">pdf_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;orca_pred.ref.l.pdf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;orca_pred.ref.r.pdf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;orca_pred.alt.l.pdf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;orca_pred.alt.r.pdf&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">show_genes</span> <span class="ow">or</span> <span class="n">show_tracks</span><span class="p">:</span>
                <span class="n">pdf_names</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s2">&quot;orca_pred.ref.l.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.ref.r.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.alt.l.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.alt.r.anno.pdf&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="n">chrstr</span><span class="p">,</span> <span class="n">coordstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">chrstr</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">chrstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">coord_s</span><span class="p">,</span> <span class="n">coord_e</span> <span class="o">=</span> <span class="n">coordstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savedir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savedir</span><span class="p">)</span>

            <span class="n">outputs_ref_l</span><span class="p">,</span> <span class="n">outputs_ref_r</span><span class="p">,</span> <span class="n">outputs_alt_l</span><span class="p">,</span> <span class="n">outputs_alt_r</span> <span class="o">=</span> <span class="n">process_inv</span><span class="p">(</span>
                <span class="n">chrstr</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">coord_s</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">coord_e</span><span class="p">),</span>
                <span class="n">hg38</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target_available</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred&quot;</span><span class="p">,</span>
                <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
                <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;outputs_ref_l&quot;</span><span class="p">:</span> <span class="n">outputs_ref_l</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_ref_r&quot;</span><span class="p">:</span> <span class="n">outputs_ref_r</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_alt_l&quot;</span><span class="p">:</span> <span class="n">outputs_alt_l</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_alt_r&quot;</span><span class="p">:</span> <span class="n">outputs_alt_r</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred.pth&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">predtype</span> <span class="o">==</span> <span class="s2">&quot;break&quot;</span><span class="p">:</span>
            <span class="n">pdf_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orca_pred.ref.1.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;orca_pred.ref.2.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;orca_pred.alt.pdf&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">show_genes</span> <span class="ow">or</span> <span class="n">show_tracks</span><span class="p">:</span>
                <span class="n">pdf_names</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s2">&quot;orca_pred.ref.1.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.ref.2.anno.pdf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;orca_pred.alt.anno.pdf&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="n">chr_coord_1</span><span class="p">,</span> <span class="n">chr_coord_2</span><span class="p">,</span> <span class="n">orientations</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">chr1</span><span class="p">,</span> <span class="n">coord1</span> <span class="o">=</span> <span class="n">chr_coord_1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">chr2</span><span class="p">,</span> <span class="n">coord2</span> <span class="o">=</span> <span class="n">chr_coord_2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">chr1</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">chr1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">chr2</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">chr2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">orientation1</span><span class="p">,</span> <span class="n">orientation2</span> <span class="o">=</span> <span class="n">orientations</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savedir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savedir</span><span class="p">)</span>

            <span class="n">outputs_ref_1</span><span class="p">,</span> <span class="n">outputs_ref_2</span><span class="p">,</span> <span class="n">outputs_alt</span> <span class="o">=</span> <span class="n">process_single_breakpoint</span><span class="p">(</span>
                <span class="n">chr1</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">coord1</span><span class="p">),</span>
                <span class="n">chr2</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">coord2</span><span class="p">),</span>
                <span class="n">orientation1</span><span class="p">,</span>
                <span class="n">orientation2</span><span class="p">,</span>
                <span class="n">hg38</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target_available</span><span class="p">,</span>
                <span class="n">show_genes</span><span class="o">=</span><span class="n">show_genes</span><span class="p">,</span>
                <span class="n">show_tracks</span><span class="o">=</span><span class="n">show_tracks</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred&quot;</span><span class="p">,</span>
                <span class="n">window_radius</span><span class="o">=</span><span class="n">window_radius</span><span class="p">,</span>
                <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;outputs_ref_1&quot;</span><span class="p">:</span> <span class="n">outputs_ref_1</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_ref_2&quot;</span><span class="p">:</span> <span class="n">outputs_ref_2</span><span class="p">,</span>
                    <span class="s2">&quot;outputs_alt&quot;</span><span class="p">:</span> <span class="n">outputs_alt</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">savedir</span> <span class="o">+</span> <span class="s2">&quot;/orca_pred.pth&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected prediction type!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">get_interactions</span><span class="p">(</span><span class="n">predtype</span><span class="p">,</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;&lt;coordinate&gt;&quot;</span><span class="p">],</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;&lt;output_dir&gt;&quot;</span><span class="p">])</span>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Zhou Laboratory.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>